
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/thatbeardo/go-sentinel/api/handlers/resources/delete.go (100.0%)</option>
				
				<option value="file1">github.com/thatbeardo/go-sentinel/api/handlers/resources/get.go (100.0%)</option>
				
				<option value="file2">github.com/thatbeardo/go-sentinel/api/handlers/resources/patch.go (100.0%)</option>
				
				<option value="file3">github.com/thatbeardo/go-sentinel/api/handlers/resources/post.go (100.0%)</option>
				
				<option value="file4">github.com/thatbeardo/go-sentinel/api/handlers/resources/routes.go (100.0%)</option>
				
				<option value="file5">github.com/thatbeardo/go-sentinel/models/resource/entity.go (100.0%)</option>
				
				<option value="file6">github.com/thatbeardo/go-sentinel/models/resource/neo4j.go (100.0%)</option>
				
				<option value="file7">github.com/thatbeardo/go-sentinel/models/resource/service.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        "github.com/thatbeardo/go-sentinel/models/resource"
)

// @Summary Delete a resource by its ID
// @Tags Resources
// @Description Delete a resource by its ID
// @Accept  json
// @Produce  json
// @Param id path string true "Resource ID"
// @Success 204 {object} resource.Response        "ok"
// @Success 404 {object} views.ErrView
// @Router /v1/resources/{id} [delete]
func delete(service resource.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                id := c.Param("id")
                err := service.Delete(id)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusNoContent, nil)</span>
        }
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        "github.com/thatbeardo/go-sentinel/models/resource"
)

// @Summary Get all the resources
// @Tags Resources
// @Description Get all the resources stored
// @Accept  json
// @Produce  json
// @Success 200 {object} resource.Response        "ok"
// @Success 500 {object} views.ErrView
// @Router /v1/resources [get]
func get(service resource.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                resources, err := service.Get()
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusOK, resources)</span>
        }
}

// @Summary Get resource by ID
// @Tags Resources
// @Description Get a resource by its ID
// @Accept  json
// @Produce  json
// @Param id path string true "Resource ID"
// @Success 200 {object} resource.Element        "ok"
// @Success 404 {object} views.ErrView
// @Success 500 {object} views.ErrView
// @Router /v1/resources/{id} [get]
func getByID(service resource.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                id := c.Param("id")
                resources, err := service.GetByID(id)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusOK, resources)</span>
        }
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        "github.com/thatbeardo/go-sentinel/models/resource"
)

// @Summary Update a resource by it's ID
// @Tags Resources
// @Description Update resource name, sourceID, parent, etc
// @Accept  json
// @Produce  json
// @Param id path string true "Resource ID"
// @Param input body resource.Input true "Resource to be created"
// @Success 204 {object} resource.Response        "ok"
// @Success 404 {object} views.ErrView
// @Router /v1/resources/{id} [patch]
func patch(service resource.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                id := c.Param("id")
                var resourceInput resource.Input
                if err := c.ShouldBind(&amp;resourceInput); err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">resourceResponse, err := service.Update(id, &amp;resourceInput)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusAccepted, resourceResponse)</span>
        }
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        "github.com/thatbeardo/go-sentinel/models/resource"
)

// @Summary Create a new Resource
// @Description Add a new resource to existing resources
// @Tags Resources
// @Accept  json
// @Produce  json
// @Param input body resource.Input true "Resource to be created"
// @Success 202 {object} resource.Element        "ok"
// @Failure 500 {object} views.ErrView        "ok"
// @Router /v1/resources [post]
func post(service resource.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                var resourceInput resource.Input
                if err := c.ShouldBind(&amp;resourceInput); err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">resourceResponse, err := service.Create(&amp;resourceInput)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusAccepted, resourceResponse)</span>
        }
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package resources

import (
        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/models/resource"
)

// ResourceRoutes sets up resource specific routes on the engine instance
func ResourceRoutes(r *gin.RouterGroup, service resource.Service) <span class="cov8" title="1">{
        router := r.Group("/resources")

        router.GET("/", get(service))
        router.GET("/:id", getByID(service))
        router.POST("/", post(service))
        router.PATCH("/:id", patch(service))
        router.DELETE("/:id", delete(service))
}</span>
</pre>
		
		<pre class="file" id="file5" style="display: none">package resource

// Input is the payload that a POST endpoint expects.
type Input struct {
        Data *InputElement `json:"data" binding:"required,dive"`
}

// InputElement is the paylaod sent when creating a new resource
type InputElement struct {
        Type          string              `json:"type" binding:"required"`
        Attributes    *Resource           `json:"attributes" binding:"required,dive"`
        Relationships *RelationshipsInput `json:"relationships,omitempty"`
}

// RelationshipsInput represent the relationships of an input payload
type RelationshipsInput struct {
        Parent *Parent `json:"parent,omitempty" binding:"required,dive"`
}

// Response represents the final payload sent back to the user
type Response struct {
        Data []Element `json:"data"`
}

// Element consists of all details of a resource
type Element struct {
        Type          string         `json:"type" binding:"required"`
        ID            string         `json:"id"`
        Attributes    *Resource      `json:"attributes" binding:"required,dive"`
        Relationships *Relationships `json:"relationships"`
}

// Relationships provides details about a given resource like policies and parent
type Relationships struct {
        Parent   *Parent   `json:"parent,omitempty"`
        Policies *Policies `json:"policies"`
}

// Identifier helps acts as a reference to any given entity
type Identifier struct {
        Type string `json:"type,omitempty" enums:"policy, resource, grant, permission" binding:"required"`
        ID   string `json:"id,omitempty" binding:"required"`
}

// Parent is the parent resource of this resource
type Parent struct {
        Data *Identifier `json:"data,omitempty" binding:"required,dive"`
}

// Policies defined list of policies applicable to this resource
type Policies struct {
        Data []*Identifier `json:"data"`
}

// Resource represents an entity created by the user.
type Resource struct {
        Name     string `json:"name"`
        SourceID string `json:"source_id" binding:"required"`
}

func constructResourceResponse(resource *Resource, id ...string) Element <span class="cov8" title="1">{
        relationships := generateResourceRelationship(id[1])
        return Element{
                Type:          "resource",
                ID:            id[0],
                Attributes:    resource,
                Relationships: relationships,
        }
}</span>

func generateResourceRelationship(id string) *Relationships <span class="cov8" title="1">{
        policy := &amp;Identifier{Type: "policy", ID: "policy-id"}
        policies := &amp;Policies{Data: []*Identifier{policy}}
        var parent *Parent

        if id != "" </span><span class="cov8" title="1">{
                parent = &amp;Parent{Data: &amp;Identifier{Type: "resource", ID: id}}
        }</span>
        <span class="cov8" title="1">relationships := &amp;Relationships{Parent: parent, Policies: policies}
        return relationships</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package resource

import (
        "fmt"

        "github.com/neo4j/neo4j-go-driver/neo4j"
        models "github.com/thatbeardo/go-sentinel/models"
)

type neo4jRepository struct {
        session neo4j.Session
}

// NewNeo4jRepository is a factory method to create a neo4j repository
func NewNeo4jRepository(session neo4j.Session) Repository <span class="cov8" title="1">{
        return &amp;neo4jRepository{session}
}</span>

// Get retrieves all the resources present in the graph
func (repo *neo4jRepository) Get() (Response, error) <span class="cov8" title="1">{
        result, err := repo.session.Run("MATCH(child:Resource) OPTIONAL MATCH (child: Resource)-[:OWNED_BY]-&gt;(parent: Resource) RETURN child.name, child.source_id, child.id, parent.id", map[string]interface{}{})
        if err != nil </span><span class="cov8" title="1">{
                return Response{}, models.ErrDatabase
        }</span>
        <span class="cov8" title="1">var dtos []Element = []Element{}
        for result.Next() </span><span class="cov8" title="1">{
                resourceName := fmt.Sprint(result.Record().GetByIndex(0))
                resourceSourceID := fmt.Sprint(result.Record().GetByIndex(1))
                id := fmt.Sprint(result.Record().GetByIndex(2))
                parentID := decodeParentID(result.Record().GetByIndex(3))
                dtos = append(dtos, constructResourceResponse(&amp;Resource{Name: resourceName, SourceID: resourceSourceID}, id, parentID))
        }</span>
        <span class="cov8" title="1">return Response{Data: dtos}, nil</span>
}

// GetByID function adds a resource node
func (repo *neo4jRepository) GetByID(id string) (Element, error) <span class="cov8" title="1">{
        result, err := repo.session.Run("MATCH(child:Resource) WHERE child.id = $id OPTIONAL MATCH (child: Resource)-[:OWNED_BY]-&gt;(parent: Resource) RETURN child.name, child.source_id, parent.id", map[string]interface{}{
                "id": id,
        })
        if err != nil </span><span class="cov8" title="1">{
                return Element{}, models.ErrDatabase
        }</span>
        <span class="cov8" title="1">var response Element
        for result.Next() </span><span class="cov8" title="1">{
                resourceName := fmt.Sprint(result.Record().GetByIndex(0))
                resourceSourceID := fmt.Sprint(result.Record().GetByIndex(1))
                parentID := decodeParentID(result.Record().GetByIndex(2))
                response = constructResourceResponse(&amp;Resource{Name: resourceName, SourceID: resourceSourceID}, id, parentID)
        }</span>
        <span class="cov8" title="1">if response.ID == "" </span><span class="cov8" title="1">{
                err = models.ErrNotFound
        }</span>
        <span class="cov8" title="1">return response, err</span>
}

// Create function adds a node to the graph
func (repo *neo4jRepository) Create(resource *Input) (Element, error) <span class="cov8" title="1">{
        result, err := repo.session.Run("CREATE (n:Resource { name: $name, source_id: $source_id, id: randomUUID() }) RETURN n.id",
                map[string]interface{}{
                        "name":      resource.Data.Attributes.Name,
                        "source_id": resource.Data.Attributes.SourceID,
                })
        if err != nil </span><span class="cov8" title="1">{
                return Element{}, models.ErrDatabase
        }</span>
        <span class="cov8" title="1">var id string
        for result.Next() </span><span class="cov8" title="1">{
                id = fmt.Sprint(result.Record().GetByIndex(0))
        }</span>
        <span class="cov8" title="1">return constructResourceResponse(resource.Data.Attributes, id, ""), nil</span>
}

// Delete function deletes a node from the graph
func (repo *neo4jRepository) Delete(id string) error <span class="cov8" title="1">{
        result, err := repo.session.Run(`MATCH (n:Resource { id: $id }) DETACH DELETE n`,
                map[string]interface{}{
                        "id": id,
                })
        if err != nil </span><span class="cov8" title="1">{
                return models.ErrDatabase
        }</span>
        <span class="cov8" title="1">result.Next()
        summary, err := result.Summary()
        if err != nil </span><span class="cov8" title="1">{
                return models.ErrDatabase
        }</span>
        <span class="cov8" title="1">if summary.Counters().NodesDeleted() == 0 </span><span class="cov8" title="1">{
                return models.ErrNotFound
        }</span>
        <span class="cov8" title="1">return nil</span>
}

// CreateEdge function creates an edge between two resources
func (repo *neo4jRepository) CreateEdge(source string, destination string) error <span class="cov8" title="1">{
        result, err := repo.session.Run(`MATCH (parent:Resource),(child:Resource) WHERE child.id = $source AND parent.id = $destination CREATE (child)-[r:OWNED_BY]-&gt;(parent) RETURN type(r)`,
                map[string]interface{}{
                        "source":      source,
                        "destination": destination,
                })
        if err != nil </span><span class="cov8" title="1">{
                return models.ErrDatabase
        }</span>
        <span class="cov8" title="1">if result.Next(); result.Record().GetByIndex(0) != "OWNED_BY" </span><span class="cov8" title="1">{
                return models.ErrNotFound
        }</span>
        <span class="cov8" title="1">return err</span>
}

// CreateEdge function creates an edge between two resources
func (repo *neo4jRepository) DeleteEdge(source string, destination string) error <span class="cov8" title="1">{
        result, err := repo.session.Run(`MATCH (n { id: $source }) -[r:OWNED_BY]-&gt;(m {id:$destination}) DELETE r`,
                map[string]interface{}{
                        "source":      source,
                        "destination": destination,
                })
        if err != nil </span><span class="cov8" title="1">{
                return models.ErrDatabase
        }</span>
        <span class="cov8" title="1">result.Next()
        summary, err := result.Summary()
        if err != nil </span><span class="cov8" title="1">{
                return models.ErrDatabase
        }</span>
        <span class="cov8" title="1">if summary.Counters().RelationshipsDeleted() == 0 </span><span class="cov8" title="1">{
                return models.ErrNotFound
        }</span>
        <span class="cov8" title="1">return nil</span>
}

// Update function Edits the contents of a node
func (repo *neo4jRepository) Update(id string, resource *Input) (Element, error) <span class="cov8" title="1">{
        result, err := repo.session.Run("MATCH (n:Resource { id: $id }) SET n.name = $name, n.source_id = $source_id RETURN n.name, n.source_id",
                map[string]interface{}{
                        "id":        id,
                        "name":      resource.Data.Attributes.Name,
                        "source_id": resource.Data.Attributes.SourceID,
                })
        if err != nil </span><span class="cov8" title="1">{
                return Element{}, models.ErrDatabase
        }</span>
        <span class="cov8" title="1">for result.Next() </span><span class="cov8" title="1">{
                id = fmt.Sprint(result.Record().GetByIndex(0))
        }</span>
        <span class="cov8" title="1">var parentID string = ""
        if resource.Data.Relationships != nil </span><span class="cov8" title="1">{
                parentID = resource.Data.Relationships.Parent.Data.ID
        }</span>
        <span class="cov8" title="1">return constructResourceResponse(resource.Data.Attributes, id, parentID), nil</span>
}

func decodeParentID(response interface{}) string <span class="cov8" title="1">{
        if response == nil </span><span class="cov8" title="1">{
                return ""
        }</span>
        <span class="cov8" title="1">return fmt.Sprint(response)</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package resource

// Service recieves commands from handlers and forwards them to the repository
type Service interface {
        Get() (Response, error)
        GetByID(string) (Element, error)
        Create(*Input) (Element, error)
        Update(string, *Input) (Element, error)
        Delete(string) error
}

type service struct {
        repository Repository
}

// NewService creates a service instance with the repository passed
func NewService(repository Repository) Service <span class="cov8" title="1">{
        return &amp;service{repository: repository}
}</span>

func (service *service) Get() (Response, error) <span class="cov8" title="1">{
        return service.repository.Get()
}</span>

func (service *service) GetByID(id string) (Element, error) <span class="cov8" title="1">{
        return service.repository.GetByID(id)
}</span>

func (service *service) Update(id string, resource *Input) (Element, error) <span class="cov8" title="1">{
        if resource.Data.Relationships != nil </span><span class="cov8" title="1">{
                var err error
                var node Element
                if node, err = service.repository.GetByID(id); err != nil </span><span class="cov8" title="1">{
                        return Element{}, err
                }</span>

                <span class="cov8" title="1">var parent Element
                parent, err = service.repository.GetByID(resource.Data.Relationships.Parent.Data.ID)
                if err != nil </span><span class="cov8" title="1">{
                        return Element{}, err
                }</span>

                <span class="cov8" title="1">err = service.repository.CreateEdge(id, parent.ID)
                if err != nil </span><span class="cov8" title="1">{
                        return Element{}, err
                }</span>

                <span class="cov8" title="1">if node.Relationships != nil </span><span class="cov8" title="1">{
                        err = service.repository.DeleteEdge(node.ID, node.Relationships.Parent.Data.ID)
                        if err != nil </span><span class="cov8" title="1">{
                                return Element{}, err
                        }</span>
                }
        }
        <span class="cov8" title="1">return service.repository.Update(id, resource)</span>
}

func (service *service) Create(resource *Input) (Element, error) <span class="cov8" title="1">{
        if resource.Data.Relationships != nil </span><span class="cov8" title="1">{
                parent, err := service.repository.GetByID(resource.Data.Relationships.Parent.Data.ID)
                if err != nil </span><span class="cov8" title="1">{
                        return Element{}, err
                }</span>

                <span class="cov8" title="1">var child Element
                child, err = service.repository.Create(resource)
                if err != nil </span><span class="cov8" title="1">{
                        return Element{}, err
                }</span>

                <span class="cov8" title="1">err = service.repository.CreateEdge(child.ID, parent.ID)
                if err != nil </span><span class="cov8" title="1">{
                        return Element{}, err
                }</span>
                <span class="cov8" title="1">return child, nil</span>
        }
        <span class="cov8" title="1">return service.repository.Create(resource)</span>
}

func (service *service) Delete(id string) error <span class="cov8" title="1">{
        return service.repository.Delete(id)
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
