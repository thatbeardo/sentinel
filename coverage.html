
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/thatbeardo/go-sentinel/api/handlers/resources/delete.go (100.0%)</option>
				
				<option value="file1">github.com/thatbeardo/go-sentinel/api/handlers/resources/get.go (100.0%)</option>
				
				<option value="file2">github.com/thatbeardo/go-sentinel/api/handlers/resources/patch.go (100.0%)</option>
				
				<option value="file3">github.com/thatbeardo/go-sentinel/api/handlers/resources/post.go (100.0%)</option>
				
				<option value="file4">github.com/thatbeardo/go-sentinel/api/handlers/resources/routes.go (100.0%)</option>
				
				<option value="file5">github.com/thatbeardo/go-sentinel/models/resource/repository/repository.go (100.0%)</option>
				
				<option value="file6">github.com/thatbeardo/go-sentinel/models/resource/service/service.go (100.0%)</option>
				
				<option value="file7">github.com/thatbeardo/go-sentinel/models/resource/session/session.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        "github.com/thatbeardo/go-sentinel/models/resource/service"
)

// @Summary Delete a resource by its ID
// @Tags Resources
// @Description Delete a resource by its ID
// @Accept  json
// @Produce  json
// @Param id path string true "Resource ID"
// @Success 204 {object} resource.Response        "ok"
// @Success 404 {object} views.ErrView
// @Router /v1/resources/{id} [delete]
func delete(service service.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                id := c.Param("id")
                err := service.Delete(id)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusNoContent, nil)</span>
        }
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        "github.com/thatbeardo/go-sentinel/models/resource/service"
)

// @Summary Get all the resources
// @Tags Resources
// @Description Get all the resources stored
// @Accept  json
// @Produce  json
// @Success 200 {object} resource.Response        "ok"
// @Success 500 {object} views.ErrView
// @Router /v1/resources [get]
func get(service service.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                resources, err := service.Get()
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusOK, resources)</span>
        }
}

// @Summary Get resource by ID
// @Tags Resources
// @Description Get a resource by its ID
// @Accept  json
// @Produce  json
// @Param id path string true "Resource ID"
// @Success 200 {object} resource.Element        "ok"
// @Success 404 {object} views.ErrView
// @Success 500 {object} views.ErrView
// @Router /v1/resources/{id} [get]
func getByID(service service.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                id := c.Param("id")
                resources, err := service.GetByID(id)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusOK, resources)</span>
        }
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        entity "github.com/thatbeardo/go-sentinel/models/resource"
        "github.com/thatbeardo/go-sentinel/models/resource/service"
)

// @Summary Update a resource by it's ID
// @Tags Resources
// @Description Update resource name, sourceID, parent, etc
// @Accept  json
// @Produce  json
// @Param id path string true "Resource ID"
// @Param input body entity.Input true "Resource to be created"
// @Success 204 {object} resource.Response        "ok"
// @Success 404 {object} views.ErrView
// @Router /v1/resources/{id} [patch]
func patch(service service.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                id := c.Param("id")
                var resourceInput entity.Input
                if err := c.ShouldBind(&amp;resourceInput); err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">resourceResponse, err := service.Update(id, &amp;resourceInput)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusAccepted, resourceResponse)</span>
        }
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package resources

import (
        "net/http"

        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/api/views"
        entity "github.com/thatbeardo/go-sentinel/models/resource"
        "github.com/thatbeardo/go-sentinel/models/resource/service"
)

// @Summary Create a new Resource
// @Description Add a new resource to existing resources
// @Tags Resources
// @Accept  json
// @Produce  json
// @Param input body entity.Input true "Resource to be created"
// @Success 202 {object} resource.Element        "ok"
// @Failure 500 {object} views.ErrView        "ok"
// @Router /v1/resources [post]
func post(service service.Service) gin.HandlerFunc <span class="cov8" title="1">{
        return func(c *gin.Context) </span><span class="cov8" title="1">{
                var resourceInput entity.Input
                if err := c.ShouldBind(&amp;resourceInput); err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">resourceResponse, err := service.Create(&amp;resourceInput)
                if err != nil </span><span class="cov8" title="1">{
                        views.Wrap(err, c)
                        return
                }</span>
                <span class="cov8" title="1">c.JSON(http.StatusAccepted, resourceResponse)</span>
        }
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package resources

import (
        "github.com/gin-gonic/gin"
        "github.com/thatbeardo/go-sentinel/models/resource/service"
)

// ResourceRoutes sets up resource specific routes on the engine instance
func ResourceRoutes(r *gin.RouterGroup, service service.Service) <span class="cov8" title="1">{
        router := r.Group("/resources")

        router.GET("/", get(service))
        router.GET("/:id", getByID(service))
        router.POST("/", post(service))
        router.PATCH("/:id", patch(service))
        router.DELETE("/:id", delete(service))
}</span>
</pre>
		
		<pre class="file" id="file5" style="display: none">package repository

import (
        models "github.com/thatbeardo/go-sentinel/models"
        entity "github.com/thatbeardo/go-sentinel/models/resource"
        "github.com/thatbeardo/go-sentinel/models/resource/session"
)

// Repository is used by the service to communicate with the underlying database
type Repository interface {
        Get() (entity.Response, error)
        GetByID(string) (entity.Element, error)
        Create(*entity.Input) (entity.Element, error)
        Update(entity.Element, *entity.Input) (entity.Element, error)
        Delete(string) error
}

type repository struct {
        session session.Session
}

// Get retrieves all the resources present in the graph
func (repo *repository) Get() (entity.Response, error) <span class="cov8" title="1">{
        return repo.session.Execute(`
                MATCH(child:Resource) 
                OPTIONAL MATCH (child: Resource)-[:OWNED_BY]-&gt;(parent: Resource) 
                RETURN {child: child, parent: parent}`,
                map[string]interface{}{})
}</span>

// GetByID function adds a resource node
func (repo *repository) GetByID(id string) (entity.Element, error) <span class="cov8" title="1">{
        elements, err := repo.session.Execute(`
                MATCH(child:Resource) 
                WHERE child.id = $id 
                OPTIONAL MATCH (child: Resource)-[:OWNED_BY]-&gt;(parent: Resource) 
                RETURN {child: child, parent: parent}`,
                map[string]interface{}{
                        "id": id,
                })
        if len(elements.Data) == 0 </span><span class="cov8" title="1">{
                return entity.Element{}, models.ErrNotFound
        }</span>
        <span class="cov8" title="1">return elements.Data[0], err</span>
}

// Create function adds a node to the graph
func (repo *repository) Create(resource *entity.Input) (entity.Element, error) <span class="cov8" title="1">{
        var parentID string
        if resource.Data.Relationships != nil </span><span class="cov8" title="1">{
                parentID = resource.Data.Relationships.Parent.Data.ID
        }</span>
        <span class="cov8" title="1">elements, err := repo.session.Execute(`
                CREATE(child:Resource{name:$name, source_id: $source_id, id: randomUUID()})
                WITH child
                OPTIONAL MATCH(parent:Resource{id:$parent_id})
                WITH child,parent
                FOREACH (o IN CASE WHEN parent IS NOT NULL THEN [parent] ELSE [] END | CREATE (child)-[:OWNED_BY]-&gt;(parent))
                RETURN {child: child, parent: parent}`,
                map[string]interface{}{
                        "name":      resource.Data.Attributes.Name,
                        "source_id": resource.Data.Attributes.SourceID,
                        "parent_id": parentID,
                })
        if len(elements.Data) == 0 </span><span class="cov8" title="1">{
                return entity.Element{}, models.ErrNotFound
        }</span>
        <span class="cov8" title="1">return elements.Data[0], err</span>
}

// Update function Edits the contents of a node
func (repo *repository) Update(oldResource entity.Element, newResource *entity.Input) (entity.Element, error) <span class="cov8" title="1">{
        newParentID := extractParentID(newResource)
        statement := generateUpdateStatement(newParentID)
        elements, err := repo.session.Execute(statement,
                map[string]interface{}{
                        "child_id":      oldResource.ID,
                        "name":          newResource.Data.Attributes.Name,
                        "source_id":     newResource.Data.Attributes.SourceID,
                        "new_parent_id": newParentID,
                })
        if len(elements.Data) == 0 </span><span class="cov8" title="1">{
                return entity.Element{}, models.ErrNotFound
        }</span>
        <span class="cov8" title="1">return elements.Data[0], err</span>
}

// Delete function deletes a node from the graph
func (repo *repository) Delete(id string) error <span class="cov8" title="1">{
        _, err := repo.session.Execute(`
                MATCH (n:Resource { id: $id }) DETACH DELETE n`,
                map[string]interface{}{
                        "id": id,
                })
        return err
}</span>

// New is a factory method to generate repository instances
func New(session session.Session) Repository <span class="cov8" title="1">{
        return &amp;repository{
                session: session,
        }
}</span>

func extractParentID(newResource *entity.Input) string <span class="cov8" title="1">{
        var parentID string
        if newResource.Data.Relationships != nil </span><span class="cov8" title="1">{
                parentID = newResource.Data.Relationships.Parent.Data.ID
        }</span>
        <span class="cov8" title="1">return parentID</span>
}

func generateUpdateStatement(newParentID string) (statement string) <span class="cov8" title="1">{
        statement = `
                MATCH(child:Resource{id:$child_id})
                SET child.name=$name
                SET child.source_id=$source_id
                WITH child
                OPTIONAL MATCH (child)-[old_relationship:OWNED_BY]-&gt;(old_parent:Resource)`

        if newParentID == "" </span><span class="cov8" title="1">{
                statement += `RETURN {child: child, parent: old_parent}`
        }</span> else<span class="cov8" title="1"> {
                statement += `
                DETACH DELETE old_relationship
                WITH child

                OPTIONAL MATCH (new_parent:Resource{id:$new_parent_id})
                CREATE(child)-[:OWNED_BY]-&gt;(new_parent)
                RETURN {child: child, parent: new_parent}`
        }</span>
        <span class="cov8" title="1">return</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package service

import (
        entity "github.com/thatbeardo/go-sentinel/models/resource"
        "github.com/thatbeardo/go-sentinel/models/resource/repository"
)

// Service recieves commands from handlers and forwards them to the repository
type Service interface {
        Get() (entity.Response, error)
        GetByID(string) (entity.Element, error)
        Create(*entity.Input) (entity.Element, error)
        Update(string, *entity.Input) (entity.Element, error)
        Delete(string) error
}

type service struct {
        repository repository.Repository
}

// NewService creates a service instance with the repository passed
func NewService(repository repository.Repository) Service <span class="cov8" title="1">{
        return &amp;service{repository: repository}
}</span>

func (service *service) Get() (entity.Response, error) <span class="cov8" title="1">{
        return service.repository.Get()
}</span>

func (service *service) GetByID(id string) (entity.Element, error) <span class="cov8" title="1">{
        return service.repository.GetByID(id)
}</span>

func (service *service) Update(id string, resource *entity.Input) (entity.Element, error) <span class="cov8" title="1">{
        child, err := service.repository.GetByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return entity.Element{}, err
        }</span>

        <span class="cov8" title="1">if resource.Data.Relationships != nil </span><span class="cov8" title="1">{
                _, err = service.repository.GetByID(resource.Data.Relationships.Parent.Data.ID)
                if err != nil </span><span class="cov8" title="1">{
                        return entity.Element{}, err
                }</span>
        }

        <span class="cov8" title="1">return service.repository.Update(child, resource)</span>
}

func (service *service) Create(resource *entity.Input) (entity.Element, error) <span class="cov8" title="1">{
        if resource.Data.Relationships != nil </span><span class="cov8" title="1">{
                _, err := service.repository.GetByID(resource.Data.Relationships.Parent.Data.ID)
                if err != nil </span><span class="cov8" title="1">{
                        return entity.Element{}, err
                }</span>
        }
        <span class="cov8" title="1">return service.repository.Create(resource)</span>
}

func (service *service) Delete(id string) error <span class="cov8" title="1">{
        return service.repository.Delete(id)
}</span>
</pre>
		
		<pre class="file" id="file7" style="display: none">package session

import (
        "github.com/neo4j/neo4j-go-driver/neo4j"
        models "github.com/thatbeardo/go-sentinel/models"
        entity "github.com/thatbeardo/go-sentinel/models/resource"
        "github.com/thatbeardo/go-sentinel/models/resource/injection"
)

// Session interface defines methods needed to communicate/execute queries and a cleanup function when everything is done
type Session interface {
        Execute(statement string, parameters map[string]interface{}) (response entity.Response, err error)
}

type neo4jSession struct {
        session neo4j.Session
}

type resourceNode struct {
        Name     string `mapstructure:"name"`
        SourceID string `mapstructure:"source_id"`
        ID       string `mapstructure:"id"`
}

// NewNeo4jSession is a factory method to create Neo4J session instances
func NewNeo4jSession(session neo4j.Session) Session <span class="cov8" title="1">{
        return neo4jSession{
                session: session,
        }
}</span>

// Execute runs the statement passed as a query and opulates the data parameter with result
func (n neo4jSession) Execute(statement string, parameters map[string]interface{}) (response entity.Response, err error) <span class="cov8" title="1">{
        result, err := n.session.Run(statement, parameters)
        if err != nil </span><span class="cov8" title="1">{
                return entity.Response{}, models.ErrDatabase
        }</span>

        <span class="cov8" title="1">resources := []entity.Element{}
        for result.Next() </span><span class="cov8" title="1">{
                resultMap := result.Record().GetByIndex(0).(map[string]interface{})
                var childResource, parentResource resourceNode

                err = decodeResource(resultMap, "child", &amp;childResource)
                if err != nil </span><span class="cov8" title="1">{
                        return
                }</span>

                <span class="cov8" title="1">err = decodeResource(resultMap, "parent", &amp;parentResource)
                if err != nil </span><span class="cov8" title="1">{
                        return
                }</span>

                <span class="cov8" title="1">parent := generateParentResource(parentResource.ID)
                resources = append(resources, generateElement(childResource, parent))</span>
        }
        <span class="cov8" title="1">response = entity.Response{Data: resources}
        return</span>
}

func decodeResource(results map[string]interface{}, resourceKey string, target interface{}) (err error) <span class="cov8" title="1">{
        defer func() </span><span class="cov8" title="1">{
                if r := recover(); r != nil </span><span class="cov8" title="1">{
                        err = models.ErrDatabase
                }</span>
        }()
        <span class="cov8" title="1">if results[resourceKey] != nil </span><span class="cov8" title="1">{
                node := results[resourceKey].(neo4j.Node)
                err = injection.MapDecoder(node.Props(), &amp;target)
        }</span>
        <span class="cov8" title="1">return</span>
}

func generateParentResource(parentResourceID string) (parent *entity.Parent) <span class="cov8" title="1">{
        if parentResourceID != "" </span><span class="cov8" title="1">{
                parent = &amp;entity.Parent{
                        Data: &amp;entity.Identifier{
                                Type: "resource",
                                ID:   parentResourceID,
                        },
                }
        }</span>
        <span class="cov8" title="1">return</span>
}

func generateElement(childResource resourceNode, parent *entity.Parent) (element entity.Element) <span class="cov8" title="1">{
        return entity.Element{
                Type: "resource",
                ID:   childResource.ID,
                Attributes: &amp;entity.Resource{
                        Name:     childResource.Name,
                        SourceID: childResource.SourceID,
                },
                Relationships: &amp;entity.Relationships{
                        Parent: parent,
                },
        }
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
